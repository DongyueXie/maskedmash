---
title: "Fix the mash issue with low rank matrix, Large N"
author: "DongyueXie"
date: "2021-03-05"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

set $n_1=n_2=10^5$

```{r,message=FALSE,results=FALSE}
library(mvtnorm)
source('code/misc/genData.R')
files.sources = list.files('code/maskedmashr/')
sapply(files.sources, function(x){source(paste('code/maskedmashr/',x,sep=''))})
```



```{r}
mashfixN1e5 = readRDS('output/mashfixN1e5.rds')
R = ncol(mashfixN1e5$simdata$B)
nu = R+1
```

```{r}
U.est = mashfixN1e5$U.ed$Ulist
fp = cbind(unlist(fdp_power(mashfixN1e5$out_mash_true$result$lfsr,mashfixN1e5$simdata$B)),
           unlist(fdp_power(mashfixN1e5$out_mash$result$lfsr,mashfixN1e5$simdata$B)),
           unlist(fdp_power(mashfixN1e5$out_mash_prior$result$lfsr,mashfixN1e5$simdata$B)),
           unlist(fdp_power(mashfixN1e5$out_mash_lb$result$lfsr,mashfixN1e5$simdata$B)))

colnames(fp) = c("True.U","U.ed","U.ed.prior","U.ed.lb")
knitr::kable(round(fp,3),caption = "Set lfsr level at 0.05, output fdp")

fp = cbind(unlist(fsp_power(mashfixN1e5$out_mash_true$result$lfsr,mashfixN1e5$simdata$Bhat,mashfixN1e5$simdata$B)),
           unlist(fsp_power(mashfixN1e5$out_mash$result$lfsr,mashfixN1e5$simdata$Bhat,mashfixN1e5$simdata$B)),
           unlist(fsp_power(mashfixN1e5$out_mash_prior$result$lfsr,mashfixN1e5$simdata$Bhat,mashfixN1e5$simdata$B)),
           unlist(fsp_power(mashfixN1e5$out_mash_lb$result$lfsr,mashfixN1e5$simdata$Bhat,mashfixN1e5$simdata$B)))

colnames(fp) = c("True.U","U.ed","U.ed.prior","U.ed.lb")
knitr::kable(round(fp,3),caption = "Set lfsr level at 0.05, output fsp")

cm = cbind(c(cor(c(mashfixN1e5$out_mash_true$result$lfsr),c(mashfixN1e5$out_mash$result$lfsr)),rmse(c(mashfixN1e5$out_mash_true$result$lfsr),c(mashfixN1e5$out_mash$result$lfsr))),
           c(cor(c(mashfixN1e5$out_mash_prior$result$lfsr),c(mashfixN1e5$out_mash$result$lfsr)),rmse(c(mashfixN1e5$out_mash_prior$result$lfsr),c(mashfixN1e5$out_mash$result$lfsr))),
           c(cor(c(mashfixN1e5$out_mash_lb$result$lfsr),c(mashfixN1e5$out_mash$result$lfsr)),rmse(c(mashfixN1e5$out_mash_lb$result$lfsr),c(mashfixN1e5$out_mash$result$lfsr))))

rownames(cm) = c("cor","rmse")
colnames(cm) = c("U.ed","U.ed.prior","U.ed.lb")

knitr::kable(round(cm,3),caption = "correlation and rmse between lfsr from model with true U and model with estimated U")

cat("Prior adjustment:")


round(unlist(lapply(1:length(U.est),function(k){
  nk = 200000*mashfixN1e5$U.ed$pi[k]
  if(nk>R){
    s2.hat = R*nu/(nk+nu)/sum(diag(solve(nk*(U.est[[k]]+diag(R)))))
    ((R+1-nu+s2.hat)/(nk+nu-R-1))
  }else{
    NULL
  }
  
})),4)


cat("Lower bound adjustment:")

round(unlist(lapply(1:length(U.est),function(k){
  nk = 200000*mashfixN1e5$U.ed$pi[k]
  if(nk>R){
    
    2/sqrt(nk)
  }else{
    NULL
  }
})),4)

cat('nk:')

round(unlist(lapply(1:length(U.est),function(k){
  nk = 200000*mashfixN1e5$U.ed$pi[k]
  if(nk>R){
    nk
  }else{
    NULL
  }
})))

```

